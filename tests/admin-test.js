const axios = require("axios");

const BASE_URL = "http://localhost:3000";
let adminToken = "";
let testUserId = "";

// Colores para console
const colors = {
  green: "\x1b[32m",
  red: "\x1b[31m",
  blue: "\x1b[34m",
  yellow: "\x1b[33m",
  reset: "\x1b[0m",
  cyan: "\x1b[36m",
  magenta: "\x1b[35m",
};

function log(message, color = "reset") {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// Funci√≥n auxiliar para hacer requests
async function apiRequest(method, endpoint, data = null, useAuth = false) {
  try {
    const config = {
      method,
      url: `${BASE_URL}${endpoint}`,
      headers: {},
    };

    if (data) {
      config.data = data;
    }

    if (useAuth && adminToken) {
      config.headers.Authorization = `Bearer ${adminToken}`;
    }

    const response = await axios(config);
    return { success: true, data: response.data };
  } catch (error) {
    return {
      success: false,
      error: error.response?.data?.message || error.message,
      status: error.response?.status,
      details: error.response?.data,
    };
  }
}

// Funci√≥n para esperar (simular tiempo real)
function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

// Test completo de funcionalidades administrativas
async function runAdminTest() {
  log("üöÄ INICIANDO TEST ADMINISTRATIVO COMPLETO", "cyan");
  log("=".repeat(70), "cyan");

  try {
    // ===============================================
    // 1. LOGIN COMO ADMINISTRADOR
    // ===============================================
    log("\nüëë 1. LOGIN COMO ADMINISTRADOR...", "blue");
    const loginResult = await apiRequest("POST", "/auth/login", {
      username: "admin001", // Usuario admin existente
      password: "MiPassword123",
    });

    if (loginResult.success) {
      adminToken = loginResult.data.payload.data.tokens.accessToken;
      log("‚úÖ Login administrativo exitoso", "green");
      log(`   Admin: ${loginResult.data.payload.data.user.username}`, "green");
      log(`   Rol: ${loginResult.data.payload.data.user.role.name}`, "green");
      log(`   Token: ${adminToken.substring(0, 20)}...`, "green");
    } else {
      log(`‚ùå Login administrativo fall√≥: ${loginResult.error}`, "red");
      return;
    }

    await sleep(1000);

    // ===============================================
    // 2. LISTAR TODOS LOS USUARIOS
    // ===============================================
    log("\nüìã 2. TESTING LISTA DE USUARIOS...", "blue");
    const listResult = await apiRequest("GET", "/admin/users", null, true);

    if (listResult.success) {
      const data = listResult.data.payload.data;
      log("‚úÖ Lista de usuarios obtenida", "green");
      log(`   Total usuarios: ${data.pagination.totalUsers}`, "green");
      log(`   Usuarios activos: ${data.statistics.activeUsers}`, "green");
      log(`   Usuarios en sesi√≥n: ${data.statistics.inSessionUsers}`, "green");
      log(`   P√°gina actual: ${data.pagination.currentPage}`, "green");

      // Guardar ID del primer usuario para tests posteriores
      if (data.users.length > 0) {
        // Buscar un usuario que no sea admin para testing
        const nonAdminUser = data.users.find(
          (u) => u.role.name !== "Administrador",
        );
        if (nonAdminUser) {
          testUserId = nonAdminUser.id;
          log(
            `   Usuario seleccionado para tests: ${nonAdminUser.username}`,
            "yellow",
          );
        }
      }

      log("   Breakdown por sector:", "green");
      Object.entries(data.statistics.sectorBreakdown).forEach(
        ([sector, stats]) => {
          log(`     ${sector}: ${stats.total} usuarios`, "yellow");
        },
      );
    } else {
      log(`‚ùå Lista de usuarios fall√≥: ${listResult.error}`, "red");
    }

    await sleep(1500);

    // ===============================================
    // 3. LISTAR USUARIOS CON FILTROS
    // ===============================================
    log("\nüîç 3. TESTING FILTROS Y B√öSQUEDA...", "blue");

    // Test filtro por sector
    const filterSectorResult = await apiRequest(
      "GET",
      "/admin/users?sector=Facturacion&limit=5",
      null,
      true,
    );

    if (filterSectorResult.success) {
      const data = filterSectorResult.data.payload.data;
      log("‚úÖ Filtro por sector funcional", "green");
      log(`   Usuarios de Facturaci√≥n: ${data.users.length}`, "green");
    } else {
      log(`‚ùå Filtro por sector fall√≥: ${filterSectorResult.error}`, "red");
    }

    // Test b√∫squeda por texto
    const searchResult = await apiRequest(
      "GET",
      "/admin/users?search=user&limit=10",
      null,
      true,
    );

    if (searchResult.success) {
      const data = searchResult.data.payload.data;
      log("‚úÖ B√∫squeda por texto funcional", "green");
      log(`   Resultados encontrados: ${data.users.length}`, "green");
    } else {
      log(`‚ùå B√∫squeda fall√≥: ${searchResult.error}`, "red");
    }

    await sleep(1500);

    // ===============================================
    // 4. VER PERFIL ESPEC√çFICO DE USUARIO
    // ===============================================
    if (testUserId) {
      log("\nüë§ 4. TESTING PERFIL DE USUARIO ESPEC√çFICO...", "blue");
      const profileResult = await apiRequest(
        "GET",
        `/admin/users/${testUserId}/profile`,
        null,
        true,
      );

      if (profileResult.success) {
        const data = profileResult.data.payload.data;
        log("‚úÖ Perfil de usuario obtenido", "green");
        log(
          `   Usuario: ${data.username} (${data.firstname} ${data.lastname})`,
          "green",
        );
        log(`   Email: ${data.corporative_email}`, "green");
        log(`   Sector: ${data.sector}`, "green");
        log(`   Rol: ${data.role.name}`, "green");
        log(`   Estado: ${data.isActive ? "Activo" : "Inactivo"}`, "green");
        log(`   En sesi√≥n: ${data.isInSession ? "S√≠" : "No"}`, "green");
        log(`   Miembro desde: ${data.account.memberSince}`, "green");
        log(
          `   Puede editar: ${data.adminInfo.canEdit ? "S√≠" : "No"}`,
          "yellow",
        );
      } else {
        log(`‚ùå Perfil de usuario fall√≥: ${profileResult.error}`, "red");
      }

      await sleep(1500);

      // ===============================================
      // 5. ACTUALIZAR PERFIL DE USUARIO
      // ===============================================
      log("\n‚úèÔ∏è 5. TESTING ACTUALIZACI√ìN DE PERFIL...", "blue");
      const updateResult = await apiRequest(
        "PUT",
        `/admin/users/${testUserId}/profile`,
        {
          firstname: "NuevoNombre",
          lastname: "NuevoApellido",
        },
        true,
      );

      if (updateResult.success) {
        const data = updateResult.data.payload.data;
        log("‚úÖ Perfil actualizado exitosamente", "green");
        log(
          `   Nombre actualizado: ${data.firstname} ${data.lastname}`,
          "green",
        );
        log("   Cambios aplicados:", "green");
        data.adminAction.changesApplied.forEach((change) => {
          log(`     - ${change}`, "yellow");
        });
        log(`   Actualizado por: ${data.adminAction.performedBy}`, "yellow");
      } else {
        log(`‚ùå Actualizaci√≥n de perfil fall√≥: ${updateResult.error}`, "red");
      }

      await sleep(1500);

      // ===============================================
      // 6. CAMBIAR CONTRASE√ëA DE USUARIO
      // ===============================================
      log("\nüîê 6. TESTING CAMBIO DE CONTRASE√ëA...", "blue");
      const changePasswordResult = await apiRequest(
        "POST",
        `/admin/users/${testUserId}/change-password`,
        {
          newPassword: "NuevaPassword123",
          reason: "Test automatizado - cambio de contrase√±a",
        },
        true,
      );

      if (changePasswordResult.success) {
        const data = changePasswordResult.data.payload.data;
        log("‚úÖ Contrase√±a cambiada exitosamente", "green");
        log(`   Usuario objetivo: ${data.targetUser.username}`, "green");
        log(`   Raz√≥n: ${data.adminAction.reason}`, "green");
        log(`   Tokens revocados: S√≠`, "yellow");
        log(`   Nota de seguridad: ${data.securityNote}`, "yellow");
      } else {
        log(
          `‚ùå Cambio de contrase√±a fall√≥: ${changePasswordResult.error}`,
          "red",
        );
      }

      await sleep(1500);

      // ===============================================
      // 7. DESACTIVAR USUARIO
      // ===============================================
      log("\nüî¥ 7. TESTING DESACTIVACI√ìN DE USUARIO...", "blue");
      const deactivateResult = await apiRequest(
        "POST",
        `/admin/users/${testUserId}/toggle-status`,
        {
          reason: "Test automatizado - desactivaci√≥n temporal",
        },
        true,
      );

      if (deactivateResult.success) {
        const data = deactivateResult.data.payload.data;
        log("‚úÖ Usuario desactivado exitosamente", "green");
        log(`   Usuario: ${data.username}`, "green");
        log(
          `   Estado anterior: ${data.statusChange.previousStatus ? "Activo" : "Inactivo"}`,
          "green",
        );
        log(
          `   Estado nuevo: ${data.statusChange.newStatus ? "Activo" : "Inactivo"}`,
          "green",
        );
        log(`   Acci√≥n: ${data.statusChange.action}`, "green");
        log(`   Raz√≥n: ${data.statusChange.reason}`, "green");
        log(
          `   Tokens revocados: ${data.statusChange.tokensRevoked ? "S√≠" : "No"}`,
          "yellow",
        );
        log(
          `   Sesi√≥n cerrada: ${data.statusChange.sessionClosed ? "S√≠" : "No"}`,
          "yellow",
        );
      } else {
        log(`‚ùå Desactivaci√≥n fall√≥: ${deactivateResult.error}`, "red");
      }

      await sleep(2000);

      // ===============================================
      // 8. REACTIVAR USUARIO
      // ===============================================
      log("\nüü¢ 8. TESTING REACTIVACI√ìN DE USUARIO...", "blue");
      const reactivateResult = await apiRequest(
        "POST",
        `/admin/users/${testUserId}/toggle-status`,
        {
          reason: "Test automatizado - reactivaci√≥n despu√©s de test",
        },
        true,
      );

      if (reactivateResult.success) {
        const data = reactivateResult.data.payload.data;
        log("‚úÖ Usuario reactivado exitosamente", "green");
        log(`   Usuario: ${data.username}`, "green");
        log(
          `   Estado nuevo: ${data.statusChange.newStatus ? "Activo" : "Inactivo"}`,
          "green",
        );
        log(`   Acci√≥n: ${data.statusChange.action}`, "green");
      } else {
        log(`‚ùå Reactivaci√≥n fall√≥: ${reactivateResult.error}`, "red");
      }

      await sleep(1500);

      // ===============================================
      // 9. RESTAURAR DATOS ORIGINALES
      // ===============================================
      log("\nüîÑ 9. RESTAURANDO DATOS ORIGINALES...", "blue");
      const restoreResult = await apiRequest(
        "PUT",
        `/admin/users/${testUserId}/profile`,
        {
          firstname: "Juan", // Datos originales del usuario de prueba
          lastname: "Testing",
        },
        true,
      );

      if (restoreResult.success) {
        log("‚úÖ Datos originales restaurados", "green");
      } else {
        log(
          `‚ö†Ô∏è No se pudieron restaurar datos: ${restoreResult.error}`,
          "yellow",
        );
      }
    }

    // ===============================================
    // 10. TESTING DE SEGURIDAD
    // ===============================================
    log("\nüõ°Ô∏è 10. TESTING SEGURIDAD Y VALIDACIONES...", "blue");

    // Test: Prevenir auto-desactivaci√≥n
    const selfDeactivateResult = await apiRequest(
      "POST",
      `/admin/users/${loginResult.data.payload.data.user.id}/toggle-status`,
      {
        reason: "Intento de auto-desactivaci√≥n",
      },
      true,
    );

    if (!selfDeactivateResult.success && selfDeactivateResult.status === 409) {
      log("‚úÖ Prevenci√≥n de auto-desactivaci√≥n funcional", "green");
      log("   No se permite que admin se desactive a s√≠ mismo", "green");
    } else {
      log("‚ùå Fallo en prevenci√≥n de auto-desactivaci√≥n", "red");
    }

    // Test: Usuario inexistente
    const nonExistentResult = await apiRequest(
      "GET",
      "/admin/users/00000000-0000-0000-0000-000000000000/profile",
      null,
      true,
    );

    if (!nonExistentResult.success && nonExistentResult.status === 404) {
      log("‚úÖ Manejo de usuario inexistente funcional", "green");
    } else {
      log("‚ùå Fallo en manejo de usuario inexistente", "red");
    }

    // Test: Par√°metros inv√°lidos
    const invalidParamsResult = await apiRequest(
      "GET",
      "/admin/users?limit=150", // L√≠mite excesivo
      null,
      true,
    );

    if (!invalidParamsResult.success && invalidParamsResult.status === 400) {
      log("‚úÖ Validaci√≥n de par√°metros funcional", "green");
    } else {
      log("‚ö†Ô∏è Validaci√≥n de par√°metros puede mejorarse", "yellow");
    }

    await sleep(1000);

    // ===============================================
    // 11. RESUMEN FINAL
    // ===============================================
    log("\nüìä 11. RESUMEN DE ESTAD√çSTICAS FINALES...", "blue");
    const finalListResult = await apiRequest("GET", "/admin/users", null, true);

    if (finalListResult.success) {
      const data = finalListResult.data.payload.data;
      log("‚úÖ Estad√≠sticas finales obtenidas", "green");
      log("\nüìà RESUMEN DEL SISTEMA:", "magenta");
      log(`   üë• Total usuarios: ${data.pagination.totalUsers}`, "magenta");
      log(`   ‚úÖ Usuarios activos: ${data.statistics.activeUsers}`, "magenta");
      log(
        `   ‚ùå Usuarios inactivos: ${data.statistics.inactiveUsers}`,
        "magenta",
      );
      log(
        `   üîÑ En sesi√≥n actual: ${data.statistics.inSessionUsers}`,
        "magenta",
      );

      log("\nüè¢ BREAKDOWN POR SECTOR:", "magenta");
      Object.entries(data.statistics.sectorBreakdown).forEach(
        ([sector, stats]) => {
          log(
            `   ${sector}: ${stats.total} total, ${stats.active} activos, ${stats.inSession} en sesi√≥n`,
            "magenta",
          );
        },
      );
    }
  } catch (error) {
    log(`üí• Error inesperado en test administrativo: ${error.message}`, "red");
  }

  log("\nüéâ TEST ADMINISTRATIVO COMPLETADO", "cyan");
  log("=".repeat(70), "cyan");
}

// Test de acceso sin permisos
async function testUnauthorizedAccess() {
  log("\nüîí TESTING ACCESO NO AUTORIZADO...", "yellow");

  // Login como usuario normal
  const userLoginResult = await apiRequest("POST", "/auth/login", {
    username: "user001",
    password: "MiPassword123",
  });

  if (userLoginResult.success) {
    const userToken = userLoginResult.data.payload.data.tokens.accessToken;

    // Intentar acceso admin con token de usuario normal
    const unauthorizedResult = await apiRequest(
      "GET",
      "/admin/users",
      null,
      false,
    );
    unauthorizedResult.headers = { Authorization: `Bearer ${userToken}` };

    try {
      await axios.get(`${BASE_URL}/admin/users`, {
        headers: { Authorization: `Bearer ${userToken}` },
      });
      log("‚ùå Fallo de seguridad: usuario normal accedi√≥ a rutas admin", "red");
    } catch (error) {
      if (error.response?.status === 403) {
        log("‚úÖ Control de permisos funcional - acceso denegado", "green");
      } else {
        log("‚ö†Ô∏è Error inesperado en control de permisos", "yellow");
      }
    }
  }
}

// Ejecutar todos los tests
async function runAllAdminTests() {
  await runAdminTest();
  await testUnauthorizedAccess();

  console.log("\n‚ú® TODOS LOS TESTS ADMINISTRATIVOS COMPLETADOS");
  console.log("üîß El sistema administrativo est√° listo para producci√≥n!");
  process.exit(0);
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  runAllAdminTests().catch((error) => {
    console.error("\nüí• Error en tests administrativos:", error.message);
    process.exit(1);
  });
}

module.exports = { runAdminTest, testUnauthorizedAccess };
